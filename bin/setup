#!/bin/bash

DIR="$(dirname "$0")"
. "${DIR}/config"

# api
gcloud services enable --quiet \
    compute.googleapis.com \
    cloudbuild.googleapis.com \
    iam.googleapis.com \
    containerregistry.googleapis.com \
    run.googleapis.com \
    firestore.googleapis.com

# create passwords and tokens
mkdir -p $CONF_DIR
echo "$(openssl rand -base64 32)" > "${CONF_DIR}/service_token"
echo "db password and app token saved in:"
echo ${CONF_DIR}


# cloud run running service account
gcloud iam service-accounts create $SERVICE_NAME \
    --display-name "service account for ${SERVICE_NAME}"

gcloud projects add-iam-policy-binding $PROJECT_ID \
	--member "serviceAccount:${SA_EMAIL}" \
    --role roles/logging.logWriter

gcloud projects add-iam-policy-binding $PROJECT_ID \
	--member "serviceAccount:${SA_EMAIL}" \
    --role roles/cloudtrace.agent

gcloud projects add-iam-policy-binding $PROJECT_ID \
	--member "serviceAccount:${SA_EMAIL}" \
    --role roles/monitoring.metricWriter

gcloud projects add-iam-policy-binding $PROJECT_ID \
	--member "serviceAccount:${SA_EMAIL}" \
    --role roles/datastore.user

# cloud scheduler executor
gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member "serviceAccount:${SA_EMAIL}" \
    --role roles/cloudscheduler.serviceAgent

gcloud projects add-iam-policy-binding $PROJECT_ID \
    --member "serviceAccount:${SA_EMAIL}" \
    --role roles/run.invoker

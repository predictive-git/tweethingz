#!/bin/bash

DIR="$(dirname "$0")"
. "${DIR}/config"

export PROJECT_ID=$(gcloud config get-value project)

# build ui image

go mod tidy
go mod vendor

docker build -f ./docker/Dockerfile \
    -t "gcr.io/${PROJECT_ID}/${APP_NAME}-ui:${IMAGE_VERSION}" .
docker push "gcr.io/${PROJECT_ID}/${APP_NAME}-ui:${IMAGE_VERSION}"


# parse ui service cofnig

VARS="RELEASE=${IMAGE_VERSION}"

# DSN
VARS+=",TW_DSN=${APP_NAME}:"
VARS+=$(<"${DB_CONF_DIR}/app_password")
VARS+="@unix(/cloudsql/${PROJECT_ID}:${APP_REGION}:${DB_INSTANCE})/${APP_NAME}?parseTime=true"

# TW
VARS+=",TW_CONSUMER_KEY=${TW_CONSUMER_KEY}"
VARS+=",TW_CONSUMER_SECRET=${TW_CONSUMER_SECRET}"

# deploy ui service

gcloud beta run deploy $APP_NAME \
	--image "gcr.io/${PROJECT_ID}/${APP_NAME}-ui:${IMAGE_VERSION}" \
	--service-account $APP_SA \
	--allow-unauthenticated \
	--platform managed \
	--region $APP_REGION \
	--set-cloudsql-instances $DB_INSTANCE \
	--set-env-vars $VARS
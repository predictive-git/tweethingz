#!/bin/bash

DIR="$(dirname "$0")"
. "${DIR}/config"


go mod tidy
go mod vendor

export GO111MODULE=on
CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
    go build -a -tags netgo \
    -ldflags '-w -extldflags "-static"' \
    -mod vendor \
    -o "./bin/${APP_NAME}" \
    ./cmd/service/

gcloud compute scp "./bin/${APP_NAME}" "${APP_NAME}:/home/${USER}" --zone $VM_ZONE


# export PROJECT_ID=$(gcloud config get-value project)
# export DB_INSTANCE_IP=$(gcloud sql instances describe ${DB_INSTANCE} \
#     --format='value(ipAddresses[0].ipAddress)')

# # SERVICE
# VARS="TW_CONCURENT_REFRESH_LIMIT=${TW_CONCURENT_REFRESH_LIMIT}"

# # DSN
# VARS+=",TW_DSN=${APP_NAME}:"
# VARS+=$(<"${DB_CONF_DIR}/app_password")
# VARS+="@tcp(${DB_INSTANCE_IP:3306}})/${APP_NAME}?parseTime=true"


# # TWITTER
# VARS+=",TW_CONSUMER_KEY=${TW_CONSUMER_KEY}"
# VARS+=",TW_CONSUMER_SECRET=${TW_CONSUMER_SECRET}"






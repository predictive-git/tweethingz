#!/bin/bash

DIR="$(dirname "$0")"
. "${DIR}/config"

export PROJECT_ID=$(gcloud config get-value project)

# DSN
VARS+=",TW_DSN=${APP_NAME}:"
VARS+=$(<"${DB_CONF_DIR}/app_password")
VARS+="@unix(/cloudsql/${PROJECT_ID}:${APP_REGION}:${DB_INSTANCE})/${APP_NAME}?parseTime=true"

# TWITTER
VARS+=",TW_CONSUMER_KEY=${TW_CONSUMER_KEY}"
VARS+=",TW_CONSUMER_SECRET=${TW_CONSUMER_SECRET}"

gcloud compute instances create-with-container $APP_NAME \
	--container-image "gcr.io/${PROJECT_ID}/${APP_NAME}-worker:${IMAGE_VERSION}" \
	--machine-type $VM_TYPE \
	--zone $VM_ZONE \
	--image-family cos-stable \
	--image-project cos-cloud \
	--maintenance-policy MIGRATE \
	--scopes cloud-platform \
	--container-privileged \
	--container-env $VARS \
	--tags="${APP_NAME},demo"

